<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Blue / Green deployment | Kubernetes + Flagger + Flux + Istio</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="https://kubernetes.io/images/favicon.png">
    <meta name="description" content="Kubernetes + Flagger + Flux + Istio">
    <meta property="article:modified_time" content="2020-04-16T06:26:23.000Z">
    <meta property="og:site_name" content="Kubernetes + Flagger + Flux + Istio">
    <meta property="og:title" content="Blue / Green deployment">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/part-05/">
    <meta name="twitter:title" content="Blue / Green deployment">
    <meta name="twitter:url" content="/part-05/">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="preload" href="/k8s-flagger-istio-flux/assets/css/0.styles.a90bbd83.css" as="style"><link rel="preload" href="/k8s-flagger-istio-flux/assets/js/app.53a7754f.js" as="script"><link rel="preload" href="/k8s-flagger-istio-flux/assets/js/2.af089807.js" as="script"><link rel="preload" href="/k8s-flagger-istio-flux/assets/js/3.68b59810.js" as="script"><link rel="prefetch" href="/k8s-flagger-istio-flux/assets/js/10.eaa13707.js"><link rel="prefetch" href="/k8s-flagger-istio-flux/assets/js/11.c3dabccb.js"><link rel="prefetch" href="/k8s-flagger-istio-flux/assets/js/12.dca53ab7.js"><link rel="prefetch" href="/k8s-flagger-istio-flux/assets/js/4.2206e5ac.js"><link rel="prefetch" href="/k8s-flagger-istio-flux/assets/js/5.f906b526.js"><link rel="prefetch" href="/k8s-flagger-istio-flux/assets/js/6.379e2d20.js"><link rel="prefetch" href="/k8s-flagger-istio-flux/assets/js/7.23b8ca8e.js"><link rel="prefetch" href="/k8s-flagger-istio-flux/assets/js/8.0d565fb4.js"><link rel="prefetch" href="/k8s-flagger-istio-flux/assets/js/9.17b82358.js">
    <link rel="stylesheet" href="/k8s-flagger-istio-flux/assets/css/0.styles.a90bbd83.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/k8s-flagger-istio-flux/" class="home-link router-link-active"><img src="https://kubernetes.io/images/favicon.png" alt="Kubernetes + Flagger + Flux + Istio" class="logo"> <span class="site-name can-hide">Kubernetes + Flagger + Flux + Istio</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/k8s-flagger-istio-flux/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Links" class="dropdown-title"><span class="title">Links</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://fluxcd.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Flux
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://flagger.app" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Flagger
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/ruzickap/k8s-flagger-istio-flux" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/k8s-flagger-istio-flux/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Links" class="dropdown-title"><span class="title">Links</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://fluxcd.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Flux
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://flagger.app" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Flagger
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/ruzickap/k8s-flagger-istio-flux" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/k8s-flagger-istio-flux/" class="sidebar-link">Kubernetes + Flagger + Flux + Istio</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-flagger-istio-flux/#requirements" class="sidebar-link">Requirements</a></li><li class="sidebar-sub-header"><a href="/k8s-flagger-istio-flux/#content" class="sidebar-link">Content</a></li><li class="sidebar-sub-header"><a href="/k8s-flagger-istio-flux/#links" class="sidebar-link">Links</a></li></ul></li><li><a href="/k8s-flagger-istio-flux/part-01/" class="sidebar-link">Create k8s cluster</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-flagger-istio-flux/part-01/#prepare-the-local-working-environment" class="sidebar-link">Prepare the local working environment</a></li><li class="sidebar-sub-header"><a href="/k8s-flagger-istio-flux/part-01/#prepare-the-azure-environment" class="sidebar-link">Prepare the Azure environment</a></li><li class="sidebar-sub-header"><a href="/k8s-flagger-istio-flux/part-01/#create-k8s-in-azure" class="sidebar-link">Create k8s in Azure</a></li></ul></li><li><a href="/k8s-flagger-istio-flux/part-02/" class="sidebar-link">Install Flux</a></li><li><a href="/k8s-flagger-istio-flux/part-03/" class="sidebar-link">Install Tekton and build pipelines</a></li><li><a href="/k8s-flagger-istio-flux/part-04/" class="sidebar-link">Install Flagger</a></li><li><a href="/k8s-flagger-istio-flux/part-05/" class="active sidebar-link">Blue / Green deployment</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-flagger-istio-flux/part-05/#canary-deployment" class="sidebar-link">Canary deployment</a></li><li class="sidebar-sub-header"><a href="/k8s-flagger-istio-flux/part-05/#failed-canary-deployment" class="sidebar-link">Failed Canary deployment</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="blue-green-deployment"><a href="#blue-green-deployment" class="header-anchor">#</a> Blue / Green deployment</h1> <p>Label the <code>default</code> namespace with <code>istio-injection=enabled</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl label namespace default istio-injection<span class="token operator">=</span>enabled
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>namespace/default labeled
</code></pre></div><p>Prepare the application manifest and save it to Git repository:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> EOF <span class="token operator">&gt;</span> tmp/k8s-flux-repository/workloads/podinfo.yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: podinfo
  namespace: default
  labels:
    app: podinfo
  annotations:
    flux.weave.works/automated: <span class="token string">&quot;true&quot;</span>
spec:
  minReadySeconds: <span class="token number">5</span>
  revisionHistoryLimit: <span class="token number">5</span>
  progressDeadlineSeconds: <span class="token number">60</span>
  strategy:
    rollingUpdate:
      maxUnavailable: <span class="token number">0</span>
    type: RollingUpdate
  selector:
    matchLabels:
      app: podinfo
  template:
    metadata:
      annotations:
        prometheus.io/scrape: <span class="token string">&quot;true&quot;</span>
      labels:
        app: podinfo
    spec:
      imagePullSecrets:
      - name: docker-config
      containers:
      - name: podinfod
        image: pruzickak8smyexampledev.azurecr.io/library/podinfo:2.1.3
        ports:
        - containerPort: <span class="token number">9898</span>
          name: http
          protocol: TCP
        command:
        - ./podinfo
        - --port<span class="token operator">=</span><span class="token number">9898</span>
        - --level<span class="token operator">=</span>info
        - --random-delay<span class="token operator">=</span>false
        - --random-error<span class="token operator">=</span>false
        env:
        - name: PODINFO_UI_COLOR
          value: green
        livenessProbe:
          exec:
            command:
            - podcli
            - check
            - http
            - localhost:9898/healthz
          initialDelaySeconds: <span class="token number">5</span>
          timeoutSeconds: <span class="token number">5</span>
        readinessProbe:
          exec:
            command:
            - podcli
            - check
            - http
            - localhost:9898/readyz
          initialDelaySeconds: <span class="token number">5</span>
          timeoutSeconds: <span class="token number">5</span>
        resources:
          limits:
            cpu: 2000m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: podinfo-gateway
  namespace: default
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: <span class="token number">80</span>
      name: http-podinfo
      protocol: HTTP
    hosts:
    - podinfo.<span class="token variable">${MY_DOMAIN}</span>
  - port:
      number: <span class="token number">443</span>
      name: https-podinfo
      protocol: HTTPS
    hosts:
    - podinfo.<span class="token variable">${MY_DOMAIN}</span>
    tls:
      credentialName: ingress-cert-<span class="token variable">${LETSENCRYPT_ENVIRONMENT}</span>
      mode: SIMPLE
      privateKey: sds
      serverCertificate: sds
---
apiVersion: flagger.app/v1alpha3
kind: Canary
metadata:
  name: podinfo
  namespace: default
spec:
  <span class="token comment"># service mesh provider (default istio)</span>
  <span class="token comment"># can be: kubernetes, istio, appmesh, smi, nginx, gloo, supergloo</span>
  <span class="token comment"># use the kubernetes provider for Blue/Green style deployments</span>
  provider: istio
  <span class="token comment"># deployment reference</span>
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: podinfo
  <span class="token comment"># the maximum time in seconds for the canary deployment</span>
  <span class="token comment"># to make progress before it is rollback (default 600s)</span>
  progressDeadlineSeconds: <span class="token number">60</span>
  service:
    <span class="token comment"># container port</span>
    port: <span class="token number">9898</span>
    <span class="token comment"># port name can be http or grpc (default http)</span>
    portName: http
    <span class="token comment"># add all the other container ports</span>
    <span class="token comment"># when generating ClusterIP services (default false)</span>
    portDiscovery: <span class="token boolean">false</span>
    <span class="token comment"># Istio gateways (optional)</span>
    gateways:
    - podinfo-gateway
      <span class="token comment"># remove the mesh gateway if the public host is</span>
      <span class="token comment"># shared across multiple virtual services</span>
    <span class="token comment"># - mesh</span>
    <span class="token comment"># Istio virtual service host names (optional)</span>
    hosts:
    - podinfo.<span class="token variable">${MY_DOMAIN}</span>
  <span class="token comment"># define the canary analysis timing and KPIs</span>
  canaryAnalysis:
    <span class="token comment"># schedule interval (default 60s)</span>
    interval: 10s
    <span class="token comment"># max number of failed metric checks before rollback</span>
    threshold: <span class="token number">10</span>
    <span class="token comment"># max traffic percentage routed to canary</span>
    <span class="token comment"># percentage (0-100)</span>
    maxWeight: <span class="token number">50</span>
    <span class="token comment"># canary increment step</span>
    <span class="token comment"># percentage (0-100)</span>
    stepWeight: <span class="token number">5</span>
    <span class="token comment"># Prometheus checks</span>
    metrics:
    - name: request-success-rate
      <span class="token comment"># minimum req success rate (non 5xx responses)</span>
      <span class="token comment"># percentage (0-100)</span>
      threshold: <span class="token number">99</span>
      interval: 1m
    - name: request-duration
      <span class="token comment"># maximum req duration P99</span>
      <span class="token comment"># milliseconds</span>
      threshold: <span class="token number">500</span>
      interval: 30s
EOF
</code></pre></div><p>Push the manifest file into the git repository:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> -C tmp/k8s-flux-repository <span class="token function">add</span> --verbose <span class="token builtin class-name">.</span>
<span class="token function">git</span> -C tmp/k8s-flux-repository commit -m <span class="token string">&quot;Add podinfo application&quot;</span>
<span class="token function">git</span> -C tmp/k8s-flux-repository push -q
fluxctl <span class="token function">sync</span>
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>add 'workloads/podinfo.yaml'
[master 22f3a9c] Add podinfo application
 1 file changed, 98 insertions(+)
 create mode 100644 workloads/podinfo.yaml
Synchronizing with git@github.com:ruzickap/k8s-flux-repository
Revision of master to apply is 22f3a9c
Waiting for 22f3a9c to be applied ...
Done.
</code></pre></div><p>If you open the <a href="http://podinfo.myexample.dev" target="_blank" rel="noopener noreferrer">http://podinfo.myexample.dev<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> you
should see the following application:</p> <p><img src="/k8s-flagger-istio-flux/assets/img/podinfo.f7582c4d.png" alt="Podinfo" title="Podinfo"></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">if</span> <span class="token punctuation">[</span> -x /usr/bin/falkon <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> falkon http://podinfo.<span class="token variable">${MY_DOMAIN}</span> <span class="token operator">&amp;</span> <span class="token keyword">fi</span>
</code></pre></div><p>The application should be ready. Verify the canary deployment details:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl describe canaries.flagger.app podinfo
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>Name:         podinfo
Namespace:    default
Labels:       fluxcd.io/sync-gc-mark=sha256.suFcgXeCzNfy8IJ1JhXT7MbBGtOihk5WMiPqxL3zuOY
Annotations:  fluxcd.io/sync-checksum: 82d7e7352c7d652cb326d2510831c2d82d1c48f6
              kubectl.kubernetes.io/last-applied-configuration:
                {&quot;apiVersion&quot;:&quot;flagger.app/v1alpha3&quot;,&quot;kind&quot;:&quot;Canary&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;fluxcd.io/sync-checksum&quot;:&quot;82d7e7352c7d652cb326d2510831c2d...
API Version:  flagger.app/v1alpha3
Kind:         Canary
Metadata:
  Creation Timestamp:  2019-09-19T06:32:30Z
  Generation:          1
  Resource Version:    7504
  Self Link:           /apis/flagger.app/v1alpha3/namespaces/default/canaries/podinfo
  UID:                 41ae5dd2-daa7-11e9-b8e0-e21b22ce44b3
Spec:
  Canary Analysis:
    Interval:    10s
    Max Weight:  50
    Metrics:
      Interval:               1m
      Name:                   request-success-rate
      Threshold:              99
      Interval:               30s
      Name:                   request-duration
      Threshold:              500
    Step Weight:              5
    Threshold:                10
  Progress Deadline Seconds:  60
  Provider:                   istio
  Service:
    Gateways:
      podinfo-gateway
    Hosts:
      podinfo.myexample.dev
    Port:            9898
    Port Discovery:  false
    Port Name:       http
  Target Ref:
    API Version:  apps/v1
    Kind:         Deployment
    Name:         podinfo
Status:
  Canary Weight:  0
  Conditions:
    Last Transition Time:  2019-09-19T06:33:07Z
    Last Update Time:      2019-09-19T06:33:07Z
    Message:               Deployment initialization completed.
    Reason:                Initialized
    Status:                True
    Type:                  Promoted
  Failed Checks:           0
  Iterations:              0
  Last Applied Spec:       3370313630240737
  Last Transition Time:    2019-09-19T06:33:07Z
  Phase:                   Initialized
  Tracked Configs:
Events:
  Type     Reason  Age                From     Message
  ----     ------  ----               ----     -------
  Warning  Synced  40s (x3 over 59s)  flagger  Halt advancement podinfo-primary.default waiting for rollout to finish: 0 of 1 updated replicas are available
  Normal   Synced  30s                flagger  Initialization done! podinfo.default
</code></pre></div><p>The original deployment <code>podinfo</code> doesn't have any pods now and new deployment
<code>podinfo-primary</code> was created by Flagger which takes care about the traffic:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl get deployment
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>NAME              READY   UP-TO-DATE   AVAILABLE   AGE
podinfo           0/0     0            0           7m3s
podinfo-primary   1/1     1            1           117s
</code></pre></div><p>There are three new services created
by Flagger - <code>podinfo-canary</code> and <code>podinfo-primary</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl get services
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>NAME              TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
kubernetes        ClusterIP   10.0.0.1       &lt;none&gt;        443/TCP    43m
podinfo           ClusterIP   10.0.4.160     &lt;none&gt;        9898/TCP   3m38s
podinfo-canary    ClusterIP   10.0.179.151   &lt;none&gt;        9898/TCP   3m38s
podinfo-primary   ClusterIP   10.0.29.128    &lt;none&gt;        9898/TCP   3m38s
</code></pre></div><p>There is also new <code>VirtualService</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl describe virtualservices.networking.istio.io podinfo
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>Name:         podinfo
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
API Version:  networking.istio.io/v1alpha3
Kind:         VirtualService
Metadata:
  Creation Timestamp:  2019-09-19T06:32:38Z
  Generation:          1
  Owner References:
    API Version:           flagger.app/v1alpha3
    Block Owner Deletion:  true
    Controller:            true
    Kind:                  Canary
    Name:                  podinfo
    UID:                   41ae5dd2-daa7-11e9-b8e0-e21b22ce44b3
  Resource Version:        7403
  Self Link:               /apis/networking.istio.io/v1alpha3/namespaces/default/virtualservices/podinfo
  UID:                     4621815f-daa7-11e9-b8e0-e21b22ce44b3
Spec:
  Gateways:
    podinfo-gateway
  Hosts:
    podinfo.myexample.dev
    podinfo
  Http:
    Route:
      Destination:
        Host:  podinfo-primary
      Weight:  100
      Destination:
        Host:  podinfo-canary
      Weight:  0
Events:        &lt;none&gt;
</code></pre></div><p>You can also see two new <code>DestinationRules</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl describe destinationrules.networking.istio.io
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>Name:         podinfo-canary
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
API Version:  networking.istio.io/v1alpha3
Kind:         DestinationRule
Metadata:
  Creation Timestamp:  2019-09-19T06:32:37Z
  Generation:          1
  Owner References:
    API Version:           flagger.app/v1alpha3
    Block Owner Deletion:  true
    Controller:            true
    Kind:                  Canary
    Name:                  podinfo
    UID:                   41ae5dd2-daa7-11e9-b8e0-e21b22ce44b3
  Resource Version:        7400
  Self Link:               /apis/networking.istio.io/v1alpha3/namespaces/default/destinationrules/podinfo-canary
  UID:                     45ed89ac-daa7-11e9-b8e0-e21b22ce44b3
Spec:
  Host:  podinfo-canary
Events:  &lt;none&gt;


Name:         podinfo-primary
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
API Version:  networking.istio.io/v1alpha3
Kind:         DestinationRule
Metadata:
  Creation Timestamp:  2019-09-19T06:32:38Z
  Generation:          1
  Owner References:
    API Version:           flagger.app/v1alpha3
    Block Owner Deletion:  true
    Controller:            true
    Kind:                  Canary
    Name:                  podinfo
    UID:                   41ae5dd2-daa7-11e9-b8e0-e21b22ce44b3
  Resource Version:        7401
  Self Link:               /apis/networking.istio.io/v1alpha3/namespaces/default/destinationrules/podinfo-primary
  UID:                     460d1352-daa7-11e9-b8e0-e21b22ce44b3
Spec:
  Host:  podinfo-primary
Events:  &lt;none&gt;
</code></pre></div><p>Configure Tekton pipelines to build new version of <code>podinfo</code> application:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sed</span> -i <span class="token string">&quot;s/2.1.3/3.0.0/&quot;</span> tmp/k8s-flux-repository/workloads/tekton-pipelineresource.yaml
<span class="token function">git</span> -C tmp/k8s-flux-repository <span class="token function">diff</span>
<span class="token function">git</span> -C tmp/k8s-flux-repository <span class="token function">add</span> --verbose <span class="token builtin class-name">.</span>
<span class="token function">git</span> -C tmp/k8s-flux-repository commit -m <span class="token string">&quot;Increase podinfo application version and build container image&quot;</span>
<span class="token function">git</span> -C tmp/k8s-flux-repository push -q
fluxctl <span class="token function">sync</span>
</code></pre></div><p>Start building new image:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sed</span> -i <span class="token string">&quot;s/name: podinfo-build-docker-image-from-git-pipelinerun/name: podinfo-build-docker-image-from-git-pipelinerun-2/&quot;</span> tmp/k8s-flux-repository/workloads/tekton-pipelinerun.yaml
<span class="token function">git</span> -C tmp/k8s-flux-repository <span class="token function">diff</span>
<span class="token function">git</span> -C tmp/k8s-flux-repository <span class="token function">add</span> --verbose <span class="token builtin class-name">.</span>
<span class="token function">git</span> -C tmp/k8s-flux-repository commit -m <span class="token string">&quot;Build new image and upload it to ACR&quot;</span>
<span class="token function">git</span> -C tmp/k8s-flux-repository push -q
fluxctl <span class="token function">sync</span>
</code></pre></div><p>You can see the details about the pipeline here: <a href="https://tekton-dashboard.myexample.dev/#/pipelineruns" target="_blank" rel="noopener noreferrer">https://tekton-dashboard.myexample.dev/#/pipelineruns<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="/k8s-flagger-istio-flux/assets/img/tekton-dashboard.7cb3a899.png" alt="Tekton Dashboard" title="Tekton Dashboard"></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">if</span> <span class="token punctuation">[</span> -x /usr/bin/falkon <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> falkon http://tekton-dashboard.<span class="token variable">${MY_DOMAIN}</span> <span class="token operator">&amp;</span> <span class="token keyword">fi</span>
</code></pre></div><p>When the build completes the new version of the <code>podinfo</code> container image will
appear in ACR:</p> <p><img src="/k8s-flagger-istio-flux/assets/img/acr.df588aac.png" alt="ACR" title="ACR"></p> <h2 id="canary-deployment"><a href="#canary-deployment" class="header-anchor">#</a> Canary deployment</h2> <p>In few minutes the new image will be stored in ACR and Flux will automatically
deploy the new image (version <code>3.0.0</code>) into Kubernetes Deployment. The change
made by Flux into the &quot;deployment&quot; will be registered by Flagger and then the
canary deployment will start.</p> <p>Open pages in browser:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">if</span> <span class="token punctuation">[</span> -x /usr/bin/falkon <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  falkon <span class="token string">&quot;http://flagger-grafana.<span class="token variable">${MY_DOMAIN}</span>/d/flagger-istio/istio-canary?orgId=1&amp;refresh=5s&amp;var-namespace=default&amp;var-primary=podinfo-primary&amp;var-canary=podinfo&quot;</span> <span class="token operator">&amp;</span>
  falkon <span class="token string">&quot;http://grafana.<span class="token variable">${MY_DOMAIN}</span>/d/UbsSZTDik/istio-workload-dashboard?orgId=1&amp;refresh=5s&amp;var-namespace=default&amp;var-workload=podinfo-primary&amp;var-srcns=All&amp;var-srcwl=All&amp;var-dstsvc=All&quot;</span> <span class="token operator">&amp;</span>
<span class="token keyword">fi</span>
</code></pre></div><p>Run few commands in <code>tmux</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>tmux new-session <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
send-keys <span class="token string">&quot;\
  while true ; do
  fluxctl list-images --workload default:deployment/podinfo ;
  sleep 5 ;
  done
&quot;</span> C-m <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
split-window -h -p <span class="token number">27</span> <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
send-keys <span class="token string">&quot;while true; do curl -s http://podinfo.<span class="token variable">${MY_DOMAIN}</span> | jq .message; sleep 3; done&quot;</span> C-m <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
split-window -v -p <span class="token number">50</span> <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
send-keys <span class="token string">&quot;while true; do kubectl get canary/podinfo -o json | jq .status; sleep 2; done&quot;</span> C-m <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
select-pane -t <span class="token number">0</span> <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
split-window -v -p <span class="token number">50</span> <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
send-keys <span class="token string">&quot;kubectl -n istio-system logs deployment/flagger -f | jq .msg&quot;</span> C-m <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
split-window -h -p <span class="token number">39</span> <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
send-keys <span class="token string">&quot;while true ; do kubectl get canaries; sleep 3; done&quot;</span> C-m <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
set-option status off
</code></pre></div><p>Flux discovered new version of the container image in ACR and changed
the deployment to use it. You should see the following on the console:</p> <p><img src="/k8s-flagger-istio-flux/assets/img/tmux-flux-discover-new-image.c72c6d38.png" alt="tmux screenshot" title="tmux screenshot"></p> <p>Canary deployment in progress:</p> <p><img src="/k8s-flagger-istio-flux/assets/img/tmux-canary-progress.643f78ff.png" alt="tmux screenshot" title="tmux screenshot"></p> <p>Grafana showing the progress of canary deployment:</p> <p><img src="/k8s-flagger-istio-flux/assets/img/grafana-canary-progress.96b2c594.png" alt="Grafana screenshot" title="Grafana screenshot"></p> <p>Canary deployment successfully finished:</p> <p><img src="/k8s-flagger-istio-flux/assets/img/tmux-canary-completed.63a82826.png" alt="tmux screenshot" title="tmux screenshot"></p> <p>Grafana graphs when canary deployment finished:</p> <p><img src="/k8s-flagger-istio-flux/assets/img/grafana-canary-completed.57dc8413.png" alt="Grafana screenshot - Canary deployment finished" title="Grafana screenshot - Canary deployment finished"></p> <h2 id="failed-canary-deployment"><a href="#failed-canary-deployment" class="header-anchor">#</a> Failed Canary deployment</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>fluxctl deautomate --workload default:deployment/podinfo
fluxctl release --workload<span class="token operator">=</span>default:deployment/podinfo --update-image<span class="token operator">=</span>pruzickak8smyexampledev.azurecr.io/library/podinfo:2.1.3
</code></pre></div><p>Run the <code>tmux</code> commands again:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>tmux new-session <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
send-keys <span class="token string">&quot;\
  while true ; do
  fluxctl list-images --workload default:deployment/podinfo ;
  sleep 5 ;
  done
&quot;</span> C-m <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
split-window -h -p <span class="token number">27</span> <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
send-keys <span class="token string">&quot;while true; do curl -s http://podinfo.<span class="token variable">${MY_DOMAIN}</span> | jq .message; sleep 3; done&quot;</span> C-m <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
split-window -v -p <span class="token number">50</span> <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
send-keys <span class="token string">&quot;while true; do kubectl get canary/podinfo -o json | jq .status; sleep 2; done&quot;</span> C-m <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
select-pane -t <span class="token number">0</span> <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
split-window -v -p <span class="token number">50</span> <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
send-keys <span class="token string">&quot;kubectl -n istio-system logs deployment/flagger -f | jq .msg&quot;</span> C-m <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
split-window -h -p <span class="token number">39</span> <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
send-keys <span class="token string">&quot;while true ; do kubectl get canaries; sleep 3; done&quot;</span> C-m <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
set-option status off
</code></pre></div><p>Generate few HTTP 500 errors during the <code>podinfo</code> migration to new version.
The migration to new version should be stopped.</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">watch</span> <span class="token function">curl</span> -s http://podinfo.<span class="token variable">${MY_DOMAIN}</span>/status/500
</code></pre></div><p>You can see that the Flagger registered the errors (generated by curl above):</p> <p><img src="/k8s-flagger-istio-flux/assets/img/tmux-canary-started-to-fail.2e81f8ce.png" alt="Failing canary deployment" title="Failing canary deployment"></p> <p>Failing canary deployment on Grafana dashboard:</p> <p><img src="/k8s-flagger-istio-flux/assets/img/grafana-failing-canary.cb518f05.png" alt="Grafana - Failing canary deployment" title="Grafana - Failing canary deployment"></p> <p>Canary deployment failed:</p> <p><img src="/k8s-flagger-istio-flux/assets/img/tmux-canary-failed.d6594548.png" alt="Canary deployment failed" title="Canary deployment failed"></p> <p>Grafana dashboard after canary deployment failure:</p> <p><img src="/k8s-flagger-istio-flux/assets/img/grafana-canary-failed.cf1b6705.png" alt="Grafana - Canary deployment failed" title="Grafana - Canary deployment failed"></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ruzickap/k8s-flagger-istio-flux/edit/master/docs/part-05/README.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/16/2020, 6:26:23 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/k8s-flagger-istio-flux/part-04/" class="prev">
        Install Flagger
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----><div class="reading-progress top" data-v-21b39eda><div class="progress" data-v-21b39eda></div></div></div></div>
    <script src="/k8s-flagger-istio-flux/assets/js/app.53a7754f.js" defer></script><script src="/k8s-flagger-istio-flux/assets/js/2.af089807.js" defer></script><script src="/k8s-flagger-istio-flux/assets/js/3.68b59810.js" defer></script>
  </body>
</html>
