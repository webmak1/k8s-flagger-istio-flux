(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{331:function(n,a,e){n.exports=e.p+"assets/img/podinfo.f7582c4d.png"},332:function(n,a,e){n.exports=e.p+"assets/img/tekton-dashboard.7cb3a899.png"},333:function(n,a,e){n.exports=e.p+"assets/img/acr.df588aac.png"},334:function(n,a,e){n.exports=e.p+"assets/img/tmux-flux-discover-new-image.c72c6d38.png"},335:function(n,a,e){n.exports=e.p+"assets/img/tmux-canary-progress.643f78ff.png"},336:function(n,a,e){n.exports=e.p+"assets/img/grafana-canary-progress.96b2c594.png"},337:function(n,a,e){n.exports=e.p+"assets/img/tmux-canary-completed.63a82826.png"},338:function(n,a,e){n.exports=e.p+"assets/img/grafana-canary-completed.57dc8413.png"},339:function(n,a,e){n.exports=e.p+"assets/img/tmux-canary-started-to-fail.2e81f8ce.png"},340:function(n,a,e){n.exports=e.p+"assets/img/grafana-failing-canary.cb518f05.png"},341:function(n,a,e){n.exports=e.p+"assets/img/tmux-canary-failed.d6594548.png"},342:function(n,a,e){n.exports=e.p+"assets/img/grafana-canary-failed.cf1b6705.png"},351:function(n,a,e){"use strict";e.r(a);var t=e(12),s=Object(t.a)({},(function(){var n=this,a=n.$createElement,t=n._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[t("h1",{attrs:{id:"blue-green-deployment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#blue-green-deployment"}},[n._v("#")]),n._v(" Blue / Green deployment")]),n._v(" "),t("p",[n._v("Label the "),t("code",[n._v("default")]),n._v(" namespace with "),t("code",[n._v("istio-injection=enabled")]),n._v(":")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[n._v("kubectl label namespace default istio-injection"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v("enabled\n")])])]),t("p",[n._v("Output:")]),n._v(" "),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("namespace/default labeled\n")])])]),t("p",[n._v("Prepare the application manifest and save it to Git repository:")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[n._v("cat")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("<<")]),n._v(" EOF "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v(">")]),n._v(" tmp/k8s-flux-repository/workloads/podinfo.yaml\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: podinfo\n  namespace: default\n  labels:\n    app: podinfo\n  annotations:\n    flux.weave.works/automated: "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"true"')]),n._v("\nspec:\n  minReadySeconds: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("5")]),n._v("\n  revisionHistoryLimit: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("5")]),n._v("\n  progressDeadlineSeconds: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("60")]),n._v("\n  strategy:\n    rollingUpdate:\n      maxUnavailable: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("0")]),n._v("\n    type: RollingUpdate\n  selector:\n    matchLabels:\n      app: podinfo\n  template:\n    metadata:\n      annotations:\n        prometheus.io/scrape: "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"true"')]),n._v("\n      labels:\n        app: podinfo\n    spec:\n      imagePullSecrets:\n      - name: docker-config\n      containers:\n      - name: podinfod\n        image: pruzickak8smyexampledev.azurecr.io/library/podinfo:2.1.3\n        ports:\n        - containerPort: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("9898")]),n._v("\n          name: http\n          protocol: TCP\n        command:\n        - ./podinfo\n        - --port"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("9898")]),n._v("\n        - --level"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v("info\n        - --random-delay"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v("false\n        - --random-error"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v("false\n        env:\n        - name: PODINFO_UI_COLOR\n          value: green\n        livenessProbe:\n          exec:\n            command:\n            - podcli\n            - check\n            - http\n            - localhost:9898/healthz\n          initialDelaySeconds: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("5")]),n._v("\n          timeoutSeconds: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("5")]),n._v("\n        readinessProbe:\n          exec:\n            command:\n            - podcli\n            - check\n            - http\n            - localhost:9898/readyz\n          initialDelaySeconds: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("5")]),n._v("\n          timeoutSeconds: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("5")]),n._v("\n        resources:\n          limits:\n            cpu: 2000m\n            memory: 512Mi\n          requests:\n            cpu: 100m\n            memory: 64Mi\n---\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: podinfo-gateway\n  namespace: default\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n  - port:\n      number: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("80")]),n._v("\n      name: http-podinfo\n      protocol: HTTP\n    hosts:\n    - podinfo."),t("span",{pre:!0,attrs:{class:"token variable"}},[n._v("${MY_DOMAIN}")]),n._v("\n  - port:\n      number: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("443")]),n._v("\n      name: https-podinfo\n      protocol: HTTPS\n    hosts:\n    - podinfo."),t("span",{pre:!0,attrs:{class:"token variable"}},[n._v("${MY_DOMAIN}")]),n._v("\n    tls:\n      credentialName: ingress-cert-"),t("span",{pre:!0,attrs:{class:"token variable"}},[n._v("${LETSENCRYPT_ENVIRONMENT}")]),n._v("\n      mode: SIMPLE\n      privateKey: sds\n      serverCertificate: sds\n---\napiVersion: flagger.app/v1alpha3\nkind: Canary\nmetadata:\n  name: podinfo\n  namespace: default\nspec:\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# service mesh provider (default istio)")]),n._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# can be: kubernetes, istio, appmesh, smi, nginx, gloo, supergloo")]),n._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# use the kubernetes provider for Blue/Green style deployments")]),n._v("\n  provider: istio\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# deployment reference")]),n._v("\n  targetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: podinfo\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# the maximum time in seconds for the canary deployment")]),n._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# to make progress before it is rollback (default 600s)")]),n._v("\n  progressDeadlineSeconds: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("60")]),n._v("\n  service:\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# container port")]),n._v("\n    port: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("9898")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# port name can be http or grpc (default http)")]),n._v("\n    portName: http\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# add all the other container ports")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# when generating ClusterIP services (default false)")]),n._v("\n    portDiscovery: "),t("span",{pre:!0,attrs:{class:"token boolean"}},[n._v("false")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# Istio gateways (optional)")]),n._v("\n    gateways:\n    - podinfo-gateway\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# remove the mesh gateway if the public host is")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# shared across multiple virtual services")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# - mesh")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# Istio virtual service host names (optional)")]),n._v("\n    hosts:\n    - podinfo."),t("span",{pre:!0,attrs:{class:"token variable"}},[n._v("${MY_DOMAIN}")]),n._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# define the canary analysis timing and KPIs")]),n._v("\n  canaryAnalysis:\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# schedule interval (default 60s)")]),n._v("\n    interval: 10s\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# max number of failed metric checks before rollback")]),n._v("\n    threshold: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("10")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# max traffic percentage routed to canary")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# percentage (0-100)")]),n._v("\n    maxWeight: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("50")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# canary increment step")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# percentage (0-100)")]),n._v("\n    stepWeight: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("5")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# Prometheus checks")]),n._v("\n    metrics:\n    - name: request-success-rate\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# minimum req success rate (non 5xx responses)")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# percentage (0-100)")]),n._v("\n      threshold: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("99")]),n._v("\n      interval: 1m\n    - name: request-duration\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# maximum req duration P99")]),n._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[n._v("# milliseconds")]),n._v("\n      threshold: "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("500")]),n._v("\n      interval: 30s\nEOF\n")])])]),t("p",[n._v("Push the manifest file into the git repository:")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[n._v("git")]),n._v(" -C tmp/k8s-flux-repository "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("add")]),n._v(" --verbose "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[n._v(".")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("git")]),n._v(" -C tmp/k8s-flux-repository commit -m "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"Add podinfo application"')]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("git")]),n._v(" -C tmp/k8s-flux-repository push -q\nfluxctl "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("sync")]),n._v("\n")])])]),t("p",[n._v("Output:")]),n._v(" "),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("add 'workloads/podinfo.yaml'\n[master 22f3a9c] Add podinfo application\n 1 file changed, 98 insertions(+)\n create mode 100644 workloads/podinfo.yaml\nSynchronizing with git@github.com:ruzickap/k8s-flux-repository\nRevision of master to apply is 22f3a9c\nWaiting for 22f3a9c to be applied ...\nDone.\n")])])]),t("p",[n._v("If you open the "),t("a",{attrs:{href:"http://podinfo.myexample.dev",target:"_blank",rel:"noopener noreferrer"}},[n._v("http://podinfo.myexample.dev"),t("OutboundLink")],1),n._v(" you\nshould see the following application:")]),n._v(" "),t("p",[t("img",{attrs:{src:e(331),alt:"Podinfo",title:"Podinfo"}})]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("if")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("[")]),n._v(" -x /usr/bin/falkon "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("then")]),n._v(" falkon http://podinfo."),t("span",{pre:!0,attrs:{class:"token variable"}},[n._v("${MY_DOMAIN}")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("&")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("fi")]),n._v("\n")])])]),t("p",[n._v("The application should be ready. Verify the canary deployment details:")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[n._v("kubectl describe canaries.flagger.app podinfo\n")])])]),t("p",[n._v("Output:")]),n._v(" "),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('Name:         podinfo\nNamespace:    default\nLabels:       fluxcd.io/sync-gc-mark=sha256.suFcgXeCzNfy8IJ1JhXT7MbBGtOihk5WMiPqxL3zuOY\nAnnotations:  fluxcd.io/sync-checksum: 82d7e7352c7d652cb326d2510831c2d82d1c48f6\n              kubectl.kubernetes.io/last-applied-configuration:\n                {"apiVersion":"flagger.app/v1alpha3","kind":"Canary","metadata":{"annotations":{"fluxcd.io/sync-checksum":"82d7e7352c7d652cb326d2510831c2d...\nAPI Version:  flagger.app/v1alpha3\nKind:         Canary\nMetadata:\n  Creation Timestamp:  2019-09-19T06:32:30Z\n  Generation:          1\n  Resource Version:    7504\n  Self Link:           /apis/flagger.app/v1alpha3/namespaces/default/canaries/podinfo\n  UID:                 41ae5dd2-daa7-11e9-b8e0-e21b22ce44b3\nSpec:\n  Canary Analysis:\n    Interval:    10s\n    Max Weight:  50\n    Metrics:\n      Interval:               1m\n      Name:                   request-success-rate\n      Threshold:              99\n      Interval:               30s\n      Name:                   request-duration\n      Threshold:              500\n    Step Weight:              5\n    Threshold:                10\n  Progress Deadline Seconds:  60\n  Provider:                   istio\n  Service:\n    Gateways:\n      podinfo-gateway\n    Hosts:\n      podinfo.myexample.dev\n    Port:            9898\n    Port Discovery:  false\n    Port Name:       http\n  Target Ref:\n    API Version:  apps/v1\n    Kind:         Deployment\n    Name:         podinfo\nStatus:\n  Canary Weight:  0\n  Conditions:\n    Last Transition Time:  2019-09-19T06:33:07Z\n    Last Update Time:      2019-09-19T06:33:07Z\n    Message:               Deployment initialization completed.\n    Reason:                Initialized\n    Status:                True\n    Type:                  Promoted\n  Failed Checks:           0\n  Iterations:              0\n  Last Applied Spec:       3370313630240737\n  Last Transition Time:    2019-09-19T06:33:07Z\n  Phase:                   Initialized\n  Tracked Configs:\nEvents:\n  Type     Reason  Age                From     Message\n  ----     ------  ----               ----     -------\n  Warning  Synced  40s (x3 over 59s)  flagger  Halt advancement podinfo-primary.default waiting for rollout to finish: 0 of 1 updated replicas are available\n  Normal   Synced  30s                flagger  Initialization done! podinfo.default\n')])])]),t("p",[n._v("The original deployment "),t("code",[n._v("podinfo")]),n._v(" doesn't have any pods now and new deployment\n"),t("code",[n._v("podinfo-primary")]),n._v(" was created by Flagger which takes care about the traffic:")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[n._v("kubectl get deployment\n")])])]),t("p",[n._v("Output:")]),n._v(" "),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("NAME              READY   UP-TO-DATE   AVAILABLE   AGE\npodinfo           0/0     0            0           7m3s\npodinfo-primary   1/1     1            1           117s\n")])])]),t("p",[n._v("There are three new services created\nby Flagger - "),t("code",[n._v("podinfo-canary")]),n._v(" and "),t("code",[n._v("podinfo-primary")]),n._v(":")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[n._v("kubectl get services\n")])])]),t("p",[n._v("Output:")]),n._v(" "),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("NAME              TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE\nkubernetes        ClusterIP   10.0.0.1       <none>        443/TCP    43m\npodinfo           ClusterIP   10.0.4.160     <none>        9898/TCP   3m38s\npodinfo-canary    ClusterIP   10.0.179.151   <none>        9898/TCP   3m38s\npodinfo-primary   ClusterIP   10.0.29.128    <none>        9898/TCP   3m38s\n")])])]),t("p",[n._v("There is also new "),t("code",[n._v("VirtualService")]),n._v(":")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[n._v("kubectl describe virtualservices.networking.istio.io podinfo\n")])])]),t("p",[n._v("Output:")]),n._v(" "),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("Name:         podinfo\nNamespace:    default\nLabels:       <none>\nAnnotations:  <none>\nAPI Version:  networking.istio.io/v1alpha3\nKind:         VirtualService\nMetadata:\n  Creation Timestamp:  2019-09-19T06:32:38Z\n  Generation:          1\n  Owner References:\n    API Version:           flagger.app/v1alpha3\n    Block Owner Deletion:  true\n    Controller:            true\n    Kind:                  Canary\n    Name:                  podinfo\n    UID:                   41ae5dd2-daa7-11e9-b8e0-e21b22ce44b3\n  Resource Version:        7403\n  Self Link:               /apis/networking.istio.io/v1alpha3/namespaces/default/virtualservices/podinfo\n  UID:                     4621815f-daa7-11e9-b8e0-e21b22ce44b3\nSpec:\n  Gateways:\n    podinfo-gateway\n  Hosts:\n    podinfo.myexample.dev\n    podinfo\n  Http:\n    Route:\n      Destination:\n        Host:  podinfo-primary\n      Weight:  100\n      Destination:\n        Host:  podinfo-canary\n      Weight:  0\nEvents:        <none>\n")])])]),t("p",[n._v("You can also see two new "),t("code",[n._v("DestinationRules")]),n._v(":")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[n._v("kubectl describe destinationrules.networking.istio.io\n")])])]),t("p",[n._v("Output:")]),n._v(" "),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("Name:         podinfo-canary\nNamespace:    default\nLabels:       <none>\nAnnotations:  <none>\nAPI Version:  networking.istio.io/v1alpha3\nKind:         DestinationRule\nMetadata:\n  Creation Timestamp:  2019-09-19T06:32:37Z\n  Generation:          1\n  Owner References:\n    API Version:           flagger.app/v1alpha3\n    Block Owner Deletion:  true\n    Controller:            true\n    Kind:                  Canary\n    Name:                  podinfo\n    UID:                   41ae5dd2-daa7-11e9-b8e0-e21b22ce44b3\n  Resource Version:        7400\n  Self Link:               /apis/networking.istio.io/v1alpha3/namespaces/default/destinationrules/podinfo-canary\n  UID:                     45ed89ac-daa7-11e9-b8e0-e21b22ce44b3\nSpec:\n  Host:  podinfo-canary\nEvents:  <none>\n\n\nName:         podinfo-primary\nNamespace:    default\nLabels:       <none>\nAnnotations:  <none>\nAPI Version:  networking.istio.io/v1alpha3\nKind:         DestinationRule\nMetadata:\n  Creation Timestamp:  2019-09-19T06:32:38Z\n  Generation:          1\n  Owner References:\n    API Version:           flagger.app/v1alpha3\n    Block Owner Deletion:  true\n    Controller:            true\n    Kind:                  Canary\n    Name:                  podinfo\n    UID:                   41ae5dd2-daa7-11e9-b8e0-e21b22ce44b3\n  Resource Version:        7401\n  Self Link:               /apis/networking.istio.io/v1alpha3/namespaces/default/destinationrules/podinfo-primary\n  UID:                     460d1352-daa7-11e9-b8e0-e21b22ce44b3\nSpec:\n  Host:  podinfo-primary\nEvents:  <none>\n")])])]),t("p",[n._v("Configure Tekton pipelines to build new version of "),t("code",[n._v("podinfo")]),n._v(" application:")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[n._v("sed")]),n._v(" -i "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"s/2.1.3/3.0.0/"')]),n._v(" tmp/k8s-flux-repository/workloads/tekton-pipelineresource.yaml\n"),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("git")]),n._v(" -C tmp/k8s-flux-repository "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("diff")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("git")]),n._v(" -C tmp/k8s-flux-repository "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("add")]),n._v(" --verbose "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[n._v(".")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("git")]),n._v(" -C tmp/k8s-flux-repository commit -m "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"Increase podinfo application version and build container image"')]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("git")]),n._v(" -C tmp/k8s-flux-repository push -q\nfluxctl "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("sync")]),n._v("\n")])])]),t("p",[n._v("Start building new image:")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[n._v("sed")]),n._v(" -i "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"s/name: podinfo-build-docker-image-from-git-pipelinerun/name: podinfo-build-docker-image-from-git-pipelinerun-2/"')]),n._v(" tmp/k8s-flux-repository/workloads/tekton-pipelinerun.yaml\n"),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("git")]),n._v(" -C tmp/k8s-flux-repository "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("diff")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("git")]),n._v(" -C tmp/k8s-flux-repository "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("add")]),n._v(" --verbose "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[n._v(".")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("git")]),n._v(" -C tmp/k8s-flux-repository commit -m "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"Build new image and upload it to ACR"')]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("git")]),n._v(" -C tmp/k8s-flux-repository push -q\nfluxctl "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("sync")]),n._v("\n")])])]),t("p",[n._v("You can see the details about the pipeline here: "),t("a",{attrs:{href:"https://tekton-dashboard.myexample.dev/#/pipelineruns",target:"_blank",rel:"noopener noreferrer"}},[n._v("https://tekton-dashboard.myexample.dev/#/pipelineruns"),t("OutboundLink")],1)]),n._v(" "),t("p",[t("img",{attrs:{src:e(332),alt:"Tekton Dashboard",title:"Tekton Dashboard"}})]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("if")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("[")]),n._v(" -x /usr/bin/falkon "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("then")]),n._v(" falkon http://tekton-dashboard."),t("span",{pre:!0,attrs:{class:"token variable"}},[n._v("${MY_DOMAIN}")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("&")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("fi")]),n._v("\n")])])]),t("p",[n._v("When the build completes the new version of the "),t("code",[n._v("podinfo")]),n._v(" container image will\nappear in ACR:")]),n._v(" "),t("p",[t("img",{attrs:{src:e(333),alt:"ACR",title:"ACR"}})]),n._v(" "),t("h2",{attrs:{id:"canary-deployment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#canary-deployment"}},[n._v("#")]),n._v(" Canary deployment")]),n._v(" "),t("p",[n._v("In few minutes the new image will be stored in ACR and Flux will automatically\ndeploy the new image (version "),t("code",[n._v("3.0.0")]),n._v(') into Kubernetes Deployment. The change\nmade by Flux into the "deployment" will be registered by Flagger and then the\ncanary deployment will start.')]),n._v(" "),t("p",[n._v("Open pages in browser:")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("if")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("[")]),n._v(" -x /usr/bin/falkon "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("then")]),n._v("\n  falkon "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"http://flagger-grafana.'),t("span",{pre:!0,attrs:{class:"token variable"}},[n._v("${MY_DOMAIN}")]),n._v('/d/flagger-istio/istio-canary?orgId=1&refresh=5s&var-namespace=default&var-primary=podinfo-primary&var-canary=podinfo"')]),n._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("&")]),n._v("\n  falkon "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"http://grafana.'),t("span",{pre:!0,attrs:{class:"token variable"}},[n._v("${MY_DOMAIN}")]),n._v('/d/UbsSZTDik/istio-workload-dashboard?orgId=1&refresh=5s&var-namespace=default&var-workload=podinfo-primary&var-srcns=All&var-srcwl=All&var-dstsvc=All"')]),n._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("&")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("fi")]),n._v("\n")])])]),t("p",[n._v("Run few commands in "),t("code",[n._v("tmux")]),n._v(":")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[n._v("tmux new-session "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsend-keys "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"\\\n  while true ; do\n  fluxctl list-images --workload default:deployment/podinfo ;\n  sleep 5 ;\n  done\n"')]),n._v(" C-m "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsplit-window -h -p "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("27")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsend-keys "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"while true; do curl -s http://podinfo.'),t("span",{pre:!0,attrs:{class:"token variable"}},[n._v("${MY_DOMAIN}")]),n._v(' | jq .message; sleep 3; done"')]),n._v(" C-m "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsplit-window -v -p "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("50")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsend-keys "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"while true; do kubectl get canary/podinfo -o json | jq .status; sleep 2; done"')]),n._v(" C-m "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nselect-pane -t "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("0")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsplit-window -v -p "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("50")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsend-keys "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"kubectl -n istio-system logs deployment/flagger -f | jq .msg"')]),n._v(" C-m "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsplit-window -h -p "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("39")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsend-keys "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"while true ; do kubectl get canaries; sleep 3; done"')]),n._v(" C-m "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nset-option status off\n")])])]),t("p",[n._v("Flux discovered new version of the container image in ACR and changed\nthe deployment to use it. You should see the following on the console:")]),n._v(" "),t("p",[t("img",{attrs:{src:e(334),alt:"tmux screenshot",title:"tmux screenshot"}})]),n._v(" "),t("p",[n._v("Canary deployment in progress:")]),n._v(" "),t("p",[t("img",{attrs:{src:e(335),alt:"tmux screenshot",title:"tmux screenshot"}})]),n._v(" "),t("p",[n._v("Grafana showing the progress of canary deployment:")]),n._v(" "),t("p",[t("img",{attrs:{src:e(336),alt:"Grafana screenshot",title:"Grafana screenshot"}})]),n._v(" "),t("p",[n._v("Canary deployment successfully finished:")]),n._v(" "),t("p",[t("img",{attrs:{src:e(337),alt:"tmux screenshot",title:"tmux screenshot"}})]),n._v(" "),t("p",[n._v("Grafana graphs when canary deployment finished:")]),n._v(" "),t("p",[t("img",{attrs:{src:e(338),alt:"Grafana screenshot - Canary deployment finished",title:"Grafana screenshot - Canary deployment finished"}})]),n._v(" "),t("h2",{attrs:{id:"failed-canary-deployment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#failed-canary-deployment"}},[n._v("#")]),n._v(" Failed Canary deployment")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[n._v("fluxctl deautomate --workload default:deployment/podinfo\nfluxctl release --workload"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v("default:deployment/podinfo --update-image"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v("pruzickak8smyexampledev.azurecr.io/library/podinfo:2.1.3\n")])])]),t("p",[n._v("Run the "),t("code",[n._v("tmux")]),n._v(" commands again:")]),n._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[n._v("tmux new-session "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsend-keys "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"\\\n  while true ; do\n  fluxctl list-images --workload default:deployment/podinfo ;\n  sleep 5 ;\n  done\n"')]),n._v(" C-m "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsplit-window -h -p "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("27")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsend-keys "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"while true; do curl -s http://podinfo.'),t("span",{pre:!0,attrs:{class:"token variable"}},[n._v("${MY_DOMAIN}")]),n._v(' | jq .message; sleep 3; done"')]),n._v(" C-m "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsplit-window -v -p "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("50")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsend-keys "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"while true; do kubectl get canary/podinfo -o json | jq .status; sleep 2; done"')]),n._v(" C-m "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nselect-pane -t "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("0")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsplit-window -v -p "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("50")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsend-keys "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"kubectl -n istio-system logs deployment/flagger -f | jq .msg"')]),n._v(" C-m "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsplit-window -h -p "),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("39")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nsend-keys "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"while true ; do kubectl get canaries; sleep 3; done"')]),n._v(" C-m "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("\\")]),n._v("\nset-option status off\n")])])]),t("p",[n._v("Generate few HTTP 500 errors during the "),t("code",[n._v("podinfo")]),n._v(" migration to new version.\nThe migration to new version should be stopped.")]),n._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[n._v("watch")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("curl")]),n._v(" -s http://podinfo."),t("span",{pre:!0,attrs:{class:"token variable"}},[n._v("${MY_DOMAIN}")]),n._v("/status/500\n")])])]),t("p",[n._v("You can see that the Flagger registered the errors (generated by curl above):")]),n._v(" "),t("p",[t("img",{attrs:{src:e(339),alt:"Failing canary deployment",title:"Failing canary deployment"}})]),n._v(" "),t("p",[n._v("Failing canary deployment on Grafana dashboard:")]),n._v(" "),t("p",[t("img",{attrs:{src:e(340),alt:"Grafana - Failing canary deployment",title:"Grafana - Failing canary deployment"}})]),n._v(" "),t("p",[n._v("Canary deployment failed:")]),n._v(" "),t("p",[t("img",{attrs:{src:e(341),alt:"Canary deployment failed",title:"Canary deployment failed"}})]),n._v(" "),t("p",[n._v("Grafana dashboard after canary deployment failure:")]),n._v(" "),t("p",[t("img",{attrs:{src:e(342),alt:"Grafana - Canary deployment failed",title:"Grafana - Canary deployment failed"}})])])}),[],!1,null,null,null);a.default=s.exports}}]);